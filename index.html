<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Family Tree</title>
  <style>
    :root{
      --paper:#ffffff;
      --ink:#222;
      --line:#6b6b6b;
      --box:#ffffff;
      --boxStroke:#444;
    }

    html,body{height:100%; margin:0;}
    body{
      background: var(--paper);
      font-family: "Georgia", "Times New Roman", serif;
      color:var(--ink);
    }

    .wrap{
      width: min(1200px, 100%);
      margin: 0 auto;
      padding: 14px 12px 24px;
    }

    .titleRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin: 10px 0 6px;
    }

    .title{
      text-align:center;
      font-family: "Brush Script MT", "Segoe Script", "Comic Sans MS", cursive;
      font-size: clamp(34px, 4vw, 54px);
      margin: 0;
      color:#222;
    }

    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin: 6px 0 14px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .btn{
      background:#111;
      color:#fff;
      border:0;
      border-radius:10px;
      padding:10px 12px;
      font-weight:650;
      cursor:pointer;
      transition: transform 120ms ease, opacity 120ms ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,0.2);
    }

    .status{
      font-size: 13px;
      color: rgba(0,0,0,0.65);
      padding: 8px 10px;
      border: 1px dashed rgba(0,0,0,0.25);
      border-radius: 10px;
      background: rgba(0,0,0,0.03);
      min-width: 260px;
      text-align:center;
    }

    .canvas{
      width: 100%;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.08);
    }

    svg{ width:100%; height:auto; display:block; }

    /* Boxes */
    .nameBox{
      fill: var(--box);
      stroke: var(--boxStroke);
      stroke-width: 1.6;
      cursor: pointer;
    }
    .nameText{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight: 650;
      font-size: 14px;
      fill: #222;
      dominant-baseline: middle;
      text-anchor: middle;
      pointer-events: none;
    }

    .connector{
      stroke: var(--line);
      stroke-width: 1.6;
      fill: none;
      opacity: 0.9;
    }

    .branch{
      stroke: #2f2a26;
      stroke-width: 3.4;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      opacity: 0.92;
    }
    .branchThin{
      stroke: #2f2a26;
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      opacity: 0.9;
    }

    .leaf{
      stroke: rgba(0,0,0,0.10);
      stroke-width: 0.6;
      opacity: 0.95;
    }
    .leafShadow{
      filter: url(#softShadow);
      opacity: 0.9;
    }

    @media print{
      body{ background:#fff; }
      .controls{ display:none; }
      .canvas{ box-shadow:none; border:none; border-radius:0; }
      .wrap{ width:100%; padding:0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="titleRow">
      <h1 class="title">My Family Tree</h1>
    </div>

    <div class="controls">
      <button class="btn" id="saveBtn">Save to Supabase</button>
      <button class="btn secondary" id="reloadBtn">Reload</button>
      <div class="status" id="status">Loading from Supabase…</div>
    </div>

    <div class="canvas">
      <svg id="svg" viewBox="0 0 1200 800" role="img" aria-label="Family tree template">
        <defs>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="2.2" result="blur"/>
            <feOffset dx="0" dy="1" result="off"/>
            <feColorMatrix in="off" type="matrix"
              values="0 0 0 0 0
                      0 0 0 0 0
                      0 0 0 0 0
                      0 0 0 .22 0" result="shadow"/>
            <feMerge>
              <feMergeNode in="shadow"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <filter id="paperNoise">
            <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch" />
            <feColorMatrix type="matrix"
              values="1 0 0 0 0
                      0 1 0 0 0
                      0 0 1 0 0
                      0 0 0 .06 0"/>
          </filter>
        </defs>

        <rect x="0" y="0" width="1200" height="800" fill="#fff"/>
        <rect x="0" y="0" width="1200" height="800" filter="url(#paperNoise)" opacity="0.6"></rect>

        <!-- birds -->
        <g transform="translate(190 125) scale(1.05)" opacity="0.85">
          <path d="M0 0 C12 -10, 24 -10, 36 0 C26 -2, 16 4, 0 0" fill="#88a8c6" stroke="rgba(0,0,0,.15)"/>
          <circle cx="28" cy="-2" r="2.2" fill="#222"/>
        </g>
        <g transform="translate(980 130) scale(0.95)" opacity="0.85">
          <path d="M0 0 C12 -10, 24 -10, 36 0 C26 -2, 16 4, 0 0" fill="#88a8c6" stroke="rgba(0,0,0,.15)"/>
          <circle cx="28" cy="-2" r="2.2" fill="#222"/>
        </g>

        <!-- trunk + branches -->
        <g id="tree">
          <path d="
            M 600 720
            C 590 680, 585 640, 590 600
            C 596 545, 596 505, 590 455
            C 584 400, 592 340, 610 300
            C 628 260, 630 235, 622 200
            C 612 160, 600 140, 600 120
            C 600 140, 588 160, 578 200
            C 570 235, 572 260, 590 300
            C 608 340, 616 400, 610 455
            C 604 505, 604 545, 610 600
            C 615 640, 610 680, 600 720
            Z"
            fill="url(#trunkGrad)"/>
          <defs>
            <linearGradient id="trunkGrad" x1="560" y1="720" x2="650" y2="120" gradientUnits="userSpaceOnUse">
              <stop offset="0" stop-color="#4f4036"/>
              <stop offset="0.35" stop-color="#6b5648"/>
              <stop offset="1" stop-color="#5a493e"/>
            </linearGradient>
          </defs>

          <path class="branch" d="M600 260 C535 235, 470 205, 400 200" />
          <path class="branch" d="M600 285 C665 255, 735 220, 820 215" />
          <path class="branch" d="M600 330 C520 325, 450 335, 380 360" />
          <path class="branch" d="M600 340 C690 345, 770 360, 860 392" />
          <path class="branch" d="M600 410 C520 430, 470 470, 420 520" />
          <path class="branch" d="M600 420 C690 450, 760 490, 820 545" />

          <path class="branchThin" d="M420 205 C385 185, 355 170, 315 165" />
          <path class="branchThin" d="M420 205 C395 220, 368 242, 340 268" />
          <path class="branchThin" d="M380 360 C340 340, 305 330, 265 332" />
          <path class="branchThin" d="M380 360 C355 390, 330 415, 300 438" />
          <path class="branchThin" d="M420 520 C380 500, 345 492, 305 495" />
          <path class="branchThin" d="M420 520 C395 555, 368 585, 340 612" />

          <path class="branchThin" d="M820 215 C860 195, 905 182, 945 178" />
          <path class="branchThin" d="M820 215 C850 238, 878 265, 905 292" />
          <path class="branchThin" d="M860 392 C905 372, 945 368, 988 374" />
          <path class="branchThin" d="M860 392 C880 422, 905 450, 930 478" />
          <path class="branchThin" d="M820 545 C865 520, 905 512, 948 516" />
          <path class="branchThin" d="M820 545 C852 580, 880 615, 915 640" />
        </g>

        <g id="leaves" class="leafShadow"></g>
        <g id="connectors"></g>
        <g id="boxes"></g>
      </svg>
    </div>
  </div>

  <!-- IMPORTANT: Load Supabase JS ONLY ONCE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /************************************************************
     * EDIT THESE VALUES
     ************************************************************/
    const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
    const TABLE_NAME = "family_tree";  // your table name
    const TREE_ID = "bhosale";         // the row id you inserted

    const statusEl = document.getElementById("status");
    const saveBtn = document.getElementById("saveBtn");
    const reloadBtn = document.getElementById("reloadBtn");

    const leavesG = document.getElementById("leaves");
    const boxesG = document.getElementById("boxes");
    const connectorsG = document.getElementById("connectors");

    // ✅ Create the client ONCE (no duplicates)
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let CURRENT = null;

    function defaultTree() {
      return {
        trunk: "Bhahusaheb Bhosale & Vasanti Bhosale",
        center: ["Anil Bhosale","Satish Bhosale","Manish Bhosale","Girish Bhosale","",""],
        left: ["Tejaswini Bhosale","Shweta Bhosale","Atharva Bhosale","","","","","","",""],
        right: ["Aryan Bhosale","Swanandi Bhosale","Krish Bhosale","Parth Bhosale","","","","","",""]
      };
    }

    function setStatus(msg){ statusEl.textContent = msg; }

    async function loadFromSupabase(){
      setStatus("Loading from Supabase…");

      const { data, error } = await db
        .from(TABLE_NAME)
        .select("data")
        .eq("id", TREE_ID)
        .single();

      if (error) {
        console.warn(error);
        CURRENT = defaultTree();
        renderAll();
        setStatus("Could not load row (using defaults). You can still Save.");
        return;
      }

      CURRENT = (data && data.data) ? data.data : defaultTree();
      renderAll();
      setStatus("Loaded ✅ Click a box to edit, then Save.");
    }

    async function saveToSupabase(){
      if (!CURRENT) return;

      setStatus("Saving…");

      const { error } = await db
        .from(TABLE_NAME)
        .update({ data: CURRENT })
        .eq("id", TREE_ID);

      if (error) {
        console.error(error);
        setStatus("Save failed ❌ Check your RLS policies (SELECT/UPDATE true).");
        alert("Save failed. Open console (F12) for error details.");
        return;
      }

      setStatus("Saved ✅");
    }

    saveBtn.addEventListener("click", saveToSupabase);
    reloadBtn.addEventListener("click", loadFromSupabase);

    /***********************
     * SVG helpers
     ***********************/
    function addBox(key, x, y, w, h, text){
      const r = 16;

      const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
      rect.setAttribute("class","nameBox");
      rect.setAttribute("x", x);
      rect.setAttribute("y", y);
      rect.setAttribute("width", w);
      rect.setAttribute("height", h);
      rect.setAttribute("rx", r);
      rect.setAttribute("ry", r);
      rect.setAttribute("filter","url(#softShadow)");
      rect.addEventListener("click", () => editBox(key));
      boxesG.appendChild(rect);

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("class","nameText");
      t.setAttribute("x", x + w/2);
      t.setAttribute("y", y + h/2);
      t.textContent = text || "";
      boxesG.appendChild(t);

      return { x, y, w, h, cx:x+w/2, cy:y+h/2 };
    }

    function connect(from, to){
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("class","connector");
      const midX = (from.x + to.x)/2;
      path.setAttribute("d", `M ${from.x} ${from.y} L ${midX} ${from.y} L ${midX} ${to.y} L ${to.x} ${to.y}`);
      connectorsG.appendChild(path);
    }

    function leaf(x,y,rx,ry,rot,fill){
      const e = document.createElementNS("http://www.w3.org/2000/svg","ellipse");
      e.setAttribute("class","leaf");
      e.setAttribute("cx", x);
      e.setAttribute("cy", y);
      e.setAttribute("rx", rx);
      e.setAttribute("ry", ry);
      e.setAttribute("fill", fill);
      e.setAttribute("transform", `rotate(${rot} ${x} ${y})`);
      leavesG.appendChild(e);
    }

    function buildLeaves(){
      leavesG.innerHTML = "";
      const palette = ["#7fa77f","#6f9b6f","#91b791","#7aa172","#8db78c"];
      const cx = 600, cy = 300, a = 420, b = 250;

      let seed = 42;
      const rand = () => (seed = (seed*1664525 + 1013904223) % 4294967296) / 4294967296;

      for(let i=0;i<260;i++){
        let x,y;
        while(true){
          const px = cx + (rand()*2-1)*a;
          const py = cy + (rand()*2-1)*b;
          const nx = (px-cx)/a;
          const ny = (py-cy)/b;
          if(nx*nx + ny*ny <= 1.0){ x=px; y=py; break; }
        }
        if(y > 520) continue;
        leaf(x,y, 6+rand()*10, 4+rand()*8, (rand()*180)-90, palette[Math.floor(rand()*palette.length)]);
      }
    }

    function renderAll(){
      boxesG.innerHTML = "";
      connectorsG.innerHTML = "";
      buildLeaves();
      renderBoxesAndLines();
    }

    function renderBoxesAndLines(){
      // trunk
      const trunkBox = addBox("trunk", 450, 690, 300, 56, CURRENT.trunk);
      connect({x: trunkBox.cx, y: trunkBox.y}, {x: 600, y: 650});

      // center (6)
      const centerPos = [
        {x: 465, y: 420},
        {x: 675, y: 420},
        {x: 500, y: 345},
        {x: 700, y: 345},
        {x: 540, y: 505},
        {x: 660, y: 505},
      ];
      const centerTargets = [
        {x: 520, y: 405},
        {x: 680, y: 405},
        {x: 520, y: 330},
        {x: 700, y: 330},
        {x: 520, y: 520},
        {x: 700, y: 535},
      ];

      centerPos.forEach((p,i)=>{
        const b = addBox(`center.${i}`, p.x, p.y, 160, 46, (CURRENT.center && CURRENT.center[i]) || "");
        connect({x: b.x, y: b.cy}, centerTargets[i]);
      });

      // left (10 = 5 rows x 2)
      const leftRowsY = [170, 280, 390, 500, 610];
      const leftX1 = 40, leftX2 = 140;
      const spineX = 265;

      leftRowsY.forEach((y, ri)=>{
        const seg = document.createElementNS("http://www.w3.org/2000/svg","path");
        seg.setAttribute("class","connector");
        seg.setAttribute("d", `M ${spineX} ${y-10} L ${spineX} ${y+62}`);
        connectorsG.appendChild(seg);

        const branchPoint = [
          {x: 360, y: 210},
          {x: 330, y: 285},
          {x: 300, y: 365},
          {x: 305, y: 505},
          {x: 340, y: 610},
        ][ri];

        const h = document.createElementNS("http://www.w3.org/2000/svg","path");
        h.setAttribute("class","connector");
        h.setAttribute("d", `M ${spineX} ${y+26} L ${branchPoint.x} ${branchPoint.y}`);
        connectorsG.appendChild(h);

        const topIdx = ri*2;
        const botIdx = ri*2+1;

        const top = addBox(`left.${topIdx}`, leftX1, y, 190, 44, (CURRENT.left && CURRENT.left[topIdx]) || "");
        const bot = addBox(`left.${botIdx}`, leftX2, y+48, 190, 44, (CURRENT.left && CURRENT.left[botIdx]) || "");

        connect({x: top.x+top.w, y: top.cy}, {x: spineX, y: y+26});
        connect({x: bot.x+bot.w, y: bot.cy}, {x: spineX, y: y+26});
      });

      // right (10)
      const rightRowsY = [170, 280, 390, 500, 610];
      const rightX1 = 970, rightX2 = 870;
      const spineXR = 935;

      rightRowsY.forEach((y, ri)=>{
        const seg = document.createElementNS("http://www.w3.org/2000/svg","path");
        seg.setAttribute("class","connector");
        seg.setAttribute("d", `M ${spineXR} ${y-10} L ${spineXR} ${y+62}`);
        connectorsG.appendChild(seg);

        const branchPoint = [
          {x: 840, y: 215},
          {x: 880, y: 295},
          {x: 915, y: 390},
          {x: 910, y: 515},
          {x: 875, y: 640},
        ][ri];

        const h = document.createElementNS("http://www.w3.org/2000/svg","path");
        h.setAttribute("class","connector");
        h.setAttribute("d", `M ${spineXR} ${y+26} L ${branchPoint.x} ${branchPoint.y}`);
        connectorsG.appendChild(h);

        const topIdx = ri*2;
        const botIdx = ri*2+1;

        const top = addBox(`right.${topIdx}`, rightX1, y, 190, 44, (CURRENT.right && CURRENT.right[topIdx]) || "");
        const bot = addBox(`right.${botIdx}`, rightX2, y+48, 190, 44, (CURRENT.right && CURRENT.right[botIdx]) || "");

        connect({x: top.x, y: top.cy}, {x: spineXR, y: y+26});
        connect({x: bot.x, y: bot.cy}, {x: spineXR, y: y+26});
      });
    }

    function editBox(key){
      if (!CURRENT) return;

      if (key === "trunk") {
        const next = prompt("Edit trunk name:", CURRENT.trunk || "");
        if (next === null) return;
        CURRENT.trunk = next;
        renderAll();
        setStatus("Edited (not saved yet). Click Save.");
        return;
      }

      const [section, idxStr] = key.split(".");
      const idx = parseInt(idxStr, 10);
      if (!Number.isFinite(idx)) return;

      if (!CURRENT[section]) CURRENT[section] = [];
      const prev = CURRENT[section][idx] || "";
      const next = prompt(`Edit ${section} #${idx+1}:`, prev);
      if (next === null) return;

      CURRENT[section][idx] = next;
      renderAll();
      setStatus("Edited (not saved yet). Click Save.");
    }

    // Start
    loadFromSupabase();
  </script>
</body>
</html>
